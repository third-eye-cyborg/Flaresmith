# Flaresmith

**Spec-first orchestration platform for multi-environment development workflows**

Flaresmith provisions and synchronizes GitHub repos, Cloudflare Workers/Pages, Neon Postgres branches, and Postman collectionsâ€”all driven by declarative specifications.

## Features

- ðŸš€ **Project Provisioning**: Create fully-configured projects with GitHub repos, Codespaces, database branches, and deployment pipelines
- ðŸ“Š **Environment Dashboard**: Monitor dev/staging/prod environments across all integrations in one view
- ðŸ”„ **Spec-Driven Sync**: Automatically generate Zod schemas, Drizzle models, API routes, and Postman collections from spec files
- ðŸ’¬ **AI Chat + Editor**: In-browser code editor with AI assistant that proposes spec-aware edits and commits to feature branches

## Quick Start

### Prerequisites

- Node.js 20.x or later
- pnpm 9.x or later
- GitHub account with repo/workflow/codespace/environment permissions
- Cloudflare account (Workers/Pages)
- Neon Postgres account
- Postman account

### Installation

```bash
git clone https://github.com/yourusername/cloudmake.git
# Clone the repository
git clone https://github.com/yourusername/flaresmith.git
cd flaresmith

# Install dependencies
pnpm install

# Set up environment variables
cp .env.example .env
# Edit .env with your credentials. NEVER commit real secrets. See SECURITY.md.

# Start development servers
pnpm dev
```

### Development

```bash
# Run all apps in development mode
pnpm dev

# Type checking
pnpm typecheck

# Linting
pnpm lint

# Testing
pnpm test

# Build for production
pnpm build
```

## Project Structure

```
apps/
â”œâ”€â”€ api/             # Hono backend on Cloudflare Workers + Drizzle ORM
â”œâ”€â”€ admin-web/       # Next.js 14 admin portal (isolated, no billing UI)
â”œâ”€â”€ user-web/        # Next.js 14 user app (billing + subscription surfaces)
â”œâ”€â”€ admin-mobile/    # Expo admin mobile app (Neon Auth + MFA)
â””â”€â”€ user-mobile/     # Expo user mobile app (Better Auth + Billing)

packages/
â”œâ”€â”€ types/        # Zod schemas (single source of truth)
â”œâ”€â”€ api-client/   # Typed API wrapper with Zod validation
â”œâ”€â”€ ui/           # Shared React Native primitives
â”œâ”€â”€ utils/        # Hooks, helpers, env management
â””â”€â”€ config/       # ESLint, Prettier, Tailwind, tsconfig bases

specs/            # Feature specifications (spec-first workflow)
mcp/              # MCP 2.0 tool descriptors for AI agents
scripts/          # CLI utilities (provision, spec-apply, security)
```

## Architecture

Flaresmith follows a **spec-first** development model:

1. **Specifications First**: All features start in `/specs/[feature]/spec.md`
2. **Code Generation**: Zod schemas, DB models, API routes, and MCP tools are generated from specs
3. **Environment Parity**: Dev/staging/prod environments maintained consistently
4. **Idempotent Operations**: All provisioning is convergent and retryable
5. **Observability & Security**: Structured logs (requestId, traceId), rate limit & circuit breaker metrics, secret auditing & rotation (FR-031..FR-036)

### Environment Parity & Neon Branch Mapping

Canonical environments span all integrations:

| Environment | GitHub Branch | Neon Branch | Cloudflare | Postman Env |
|-------------|---------------|-------------|------------|-------------|
| dev         | feature/*     | dev         | preview    | dev         |
| staging     | staging       | staging     | staging    | staging     |
| prod        | main          | prod        | production | production  |

Neon project & branch identifiers (configure via env variables, do not hardcode):

```
NEON_PROJECT_ID=autumn-unit-81618590
NEON_BRANCH_MAIN=br-sparkling-silence-ahajm2k2
NEON_BRANCH_DEV=br-misty-base-ah2g935t
NEON_BRANCH_STAGING=br-raspy-poetry-ahesy73s
NEON_BRANCH_PROD=br-cool-feather-ahm11boj
```

These appear in `.env.example` for convenience. Use rotation-safe secrets for keys (JWT_SIGNING_KEY generated by rotation job; MASTER_ENC_KEY rotated annually).

### Provisioning Flow (User Story 1)

`POST /projects` orchestrates:
1. GitHub repo & Codespace (idempotency key `${projectId}-githubRepo-dev`)
2. Neon project/branches (keys `${projectId}-neonProject-*` / `${projectId}-neonBranch-<env>`)
3. Cloudflare Worker + Pages preview
4. Postman workspace + collections (base + env-specific)
5. Audit log entries + metrics emission (`provisioning_duration_seconds`)

Retries return existing resource IDs; collisions converge without error.

### Spec Apply (User Story 3)

`POST /specs/apply` produces deterministic artifacts:
- Zod schemas (packages/types)
- Drizzle models (apps/api/db/schema)
- Hono routes (apps/api/src/routes)
- Postman collections (postman/)
- MCP tool descriptors (mcp/servers/*)
Generates drift report with summary & conflicts array (see data-model.md). Conflicts prevent overwrite when local uncommitted changes exist.

### Chat + Editor (User Story 4)

WebSocket endpoint `/chat/stream` uses JWT query auth; context injection adds spec FR/SC IDs and recent drift summary. Optimistic locking ensures commit base SHA matches current repo head. Large files (>1MB) range-loaded (research D-003).

### Reliability & Rate Limiting

Circuit breaker: opens after â‰¥10 failures/60s, half-open probe after 30s; metrics `circuit_breaker_open_total`. Rate limiting: per-user 60/min (burst 120), per-project 300/min (burst 600); overhead target p95 <5ms. Headers: `X-RateLimit-Remaining-User`, `X-RateLimit-Remaining-Project`, `Retry-After` on 429.

### Security & Secrets

Secret scanning pre-commit + CI; secret audit logging (`secret_access_total`, `key_rotation_total`) with origin field (`user|system`). JWT signing key rotation 90d (7d grace). Encrypted secrets metadata using pgcrypto (AES-GCM). Logger redaction denies leaking token patterns.
**OAuth Provider Secrets** (Feature 003): Mobile authentication requires OAuth credentials for Apple (`OAUTH_APPLE_CLIENT_ID`, `OAUTH_APPLE_TEAM_ID`, `OAUTH_APPLE_KEY_ID`, `OAUTH_APPLE_PRIVATE_KEY`), Google (`OAUTH_GOOGLE_CLIENT_ID`, `OAUTH_GOOGLE_CLIENT_SECRET`), and GitHub (`OAUTH_GITHUB_CLIENT_ID`, `OAUTH_GITHUB_CLIENT_SECRET`). Add to GitHub Secrets (Actions scope) and sync to Codespaces/Dependabot via Feature 002's `/api/github/secrets/sync` endpoint. See `specs/003-neon-auth-migration/quickstart.md` for detailed setup.


### Preview Environments

Up to 15 active preview environments; TTL default 72h (configurable 24hâ€“168h). Cap overflow returns `409 ENV_PREVIEW_LIMIT_REACHED`. Archival job purges expired previews; metrics `preview_env_active_total`.

### Observability

Structured logs + traces (5% baseline sampling; forced for errors & slow ops). Metrics catalog includes provisioning, latency histograms, retry attempts, circuit breaker, rate limit hits, health check failures. Error envelope standardized (code, message, severity, retryPolicy, requestId, traceId, timestamp, context, hint, causeChain).

### Next Steps

1. Copy `.env.example` â†’ `.env` and fill credentials.
2. Run `pnpm dev` then provision a project via script or API.
3. Open `/projects/<id>/environments` to view environment matrix.
4. Edit spec and run spec apply script to generate artifacts.
5. Use editor/chat to propose and apply code changes.
6. Review metrics & logs for provisioning latency and rate limit overhead.

Refer to `specs/001-platform-bootstrap/spec.md` for full FR (functional requirements) and SC (success criteria) mapping.

## Multi-App Development (Dual Auth Architecture)

The repository now hosts four frontend surfaces to enforce strict admin vs user isolation while sharing a single spec-first backend:

| Surface | Directory | Auth System | Billing Context | Token Claim `type` |
|---------|-----------|-------------|-----------------|---------------------|
| Admin Web | `apps/admin-web` | Neon Auth + MFA | None | `admin` |
| User Web | `apps/user-web` | Better Auth | Polar (web checkout) | `user` |
| Admin Mobile | `apps/admin-mobile` | Neon Auth + MFA | None | `admin` |
| User Mobile | `apps/user-mobile` | Better Auth | Polar (native purchase) | `user` |

### Running Individual Surfaces

```bash
# All surfaces concurrently (admin/user web + mobile)
pnpm dev:all

# Individual targets
pnpm dev:admin-web
pnpm dev:user-web
pnpm dev:admin-mobile   # Expo Dev Tools (admin)
pnpm dev:user-mobile    # Expo Dev Tools (user)
```

`pnpm dev` (legacy) will still run all dev scripts via Turbo; prefer `pnpm dev:all` for explicit multi-app startup with filtering.

### Environment Variables

Set `APP_TYPE` to `admin` or `user` in the respective environment files (.env.admin, .env.user) so UI surfaces can conditionally render billing or audit features:

```env
APP_TYPE=admin
NEXT_PUBLIC_APP_TYPE=admin
EXPO_PUBLIC_APP_TYPE=admin
```

Admin surfaces must omit billing navigation entirely (enforced in their layouts). User surfaces include a Billing entry linking to subscription management and Polar checkout (see FR-005a/FR-049).

### Billing Isolation

Admin apps never load Polar keys or subscription state. User apps read billing flags (`USER_BILLING_ENABLED=true`) to conditionally enable checkout & receipt flows. This prevents privilege escalation and aligns with SC-003 (cross-role isolation).

### Upcoming Work

Subsequent phases will add:
- Token type enforcement middleware (`apps/api/src/middleware/tokenType.ts`)
- Session issuance & MFA routes (US1)
- Subscription & webhook handlers (US2)
- RLS migrations (US3) and mobile secure store wrappers (US4)
- Template propagation scripts (US5)

Track progress in `specs/005-dual-auth-architecture/tasks.md`.

## Documentation

- [Contributing Guide](./CONTRIBUTING.md)
- [Security Policy](./SECURITY.md)
- [Architecture Decision Records](./specs/)

## License

MIT Â© Flaresmith
