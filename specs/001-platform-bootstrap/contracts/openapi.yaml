openapi: 3.1.0
info:
  title: CloudMake Platform API
  version: 0.1.0
  description: API for project provisioning, environment dashboard, spec-driven sync, and chat operations.
servers:
  - url: https://api.cloudmake.example.com
security:
  - bearerAuth: []
paths:
  /projects:
    get:
      summary: List projects
      description: Returns a cursor-paginated list of projects.
      parameters:
        - in: query
          name: cursor
          schema: { type: string, nullable: true }
          required: false
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
          required: false
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
                  hasMore:
                    type: boolean
                  nextCursor:
                    type: string
                    nullable: true
          headers:
            X-Trace-Id:
              description: Distributed trace identifier
              schema: { type: string }
            X-Request-Id:
              description: Correlation identifier for this request
              schema: { type: string }
        '401': { $ref: '#/components/responses/Unauthorized' }
    post:
      summary: Create project
      description: Provisions a new project and dependent resources.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
          headers:
            X-Trace-Id:
              description: Distributed trace identifier
              schema: { type: string }
            X-Request-Id:
              description: Correlation identifier for this request
              schema: { type: string }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '409': { $ref: '#/components/responses/Conflict' }
  /projects/{id}:
    get:
      summary: Get project by ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
          headers:
            X-Trace-Id:
              description: Distributed trace identifier
              schema: { type: string }
            X-Request-Id:
              description: Correlation identifier for this request
              schema: { type: string }
        '404': { $ref: '#/components/responses/NotFound' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /projects/{id}/environments:
    get:
      summary: Get environment matrix for project
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
        - in: header
          name: X-Request-Id
          required: false
          schema: { type: string }
          description: Optional caller-provided idempotency / correlation identifier.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentMatrixResponse'
          headers:
            X-RateLimit-Limit-User:
              description: Maximum burst tokens allowed for the authenticated user.
              schema: { type: integer }
            X-RateLimit-Remaining-User:
              description: Remaining user-scoped tokens after this request.
              schema: { type: integer }
            X-RateLimit-Reset-User:
              description: Epoch milliseconds when user bucket will fully reset if exhausted.
              schema: { type: string }
            X-RateLimit-Limit-Project:
              description: Maximum burst tokens allowed for the targeted project.
              schema: { type: integer }
            X-RateLimit-Remaining-Project:
              description: Remaining project-scoped tokens after this request.
              schema: { type: integer }
            X-RateLimit-Reset-Project:
              description: Epoch milliseconds when project bucket will fully reset if exhausted.
              schema: { type: string }
            Retry-After:
              description: Seconds to wait before retrying (present only on 429 responses normally; documented here for completeness).
              schema: { type: integer }
            X-CircuitBreaker-GitHub:
              description: Current state of GitHub circuit breaker (closed|open|half_open).
              schema: { type: string }
            X-CircuitBreaker-Cloudflare:
              description: Current state of Cloudflare circuit breaker (closed|open|half_open).
              schema: { type: string }
            X-CircuitBreaker-Neon:
              description: Current state of Neon circuit breaker (closed|open|half_open).
              schema: { type: string }
            X-CircuitBreaker-Postman:
              description: Current state of Postman circuit breaker (closed|open|half_open).
              schema: { type: string }
        '404': { $ref: '#/components/responses/NotFound' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /projects/{id}/promote:
    post:
      summary: Promote from current environment
      description: Promote dev→staging or staging→prod based on request body.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                from:
                  type: string
                  enum: [dev, staging]
                to:
                  type: string
                  enum: [staging, prod]
              required: [from, to]
      responses:
        '202':
          description: Promotion started
          headers:
            X-Trace-Id:
              description: Distributed trace identifier
              schema: { type: string }
            X-Request-Id:
              description: Correlation identifier for this request
              schema: { type: string }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /specs/apply:
    post:
      summary: Apply spec changes
      description: Regenerate schemas/routes/tools from spec diffs.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                projectId: { type: string, format: uuid }
              required: [projectId]
      responses:
        '202':
          description: Apply started
          headers:
            X-Trace-Id:
              description: Distributed trace identifier
              schema: { type: string }
            X-Request-Id:
              description: Correlation identifier for this request
              schema: { type: string }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /chat/apply-diff:
    post:
      summary: Apply a code diff from chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApplyDiffRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  commitSha:
                    type: string
          headers:
            X-Trace-Id:
              description: Distributed trace identifier
              schema: { type: string }
            X-Request-Id:
              description: Correlation identifier for this request
              schema: { type: string }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
  schemas:
    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code: { type: string, description: Stable machine-readable error code }
            message: { type: string, description: Human-readable message }
            severity: { type: string, enum: [info, warning, error, critical] }
            retryPolicy: { type: string, enum: [none, safe, idempotent] }
            requestId: { type: string }
            timestamp: { type: string, format: date-time }
            context: { type: object, additionalProperties: true, description: Additional context (traceId, category, etc.) }
            hint: { type: string, description: Optional remediation hint }
            causeChain:
              type: array
              items: { type: string }
            details:
              type: object
              additionalProperties: true
              description: Structured detail map (validation issues, etc.)
          required: [code, message, severity, retryPolicy, requestId, timestamp]
      required: [error]
    Project:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        slug: { type: string }
        orgId: { type: string, format: uuid }
        defaultBranch: { type: string }
        status: { type: string, enum: [provisioning, active, failed] }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, name, slug, orgId, status, createdAt, updatedAt]
    Environment:
      type: object
      properties:
        id: { type: string, format: uuid }
        projectId: { type: string, format: uuid }
        name: { type: string, enum: [dev, staging, prod] }
        githubBranch: { type: string }
        cloudflareUrl: { type: string }
        neonBranchId: { type: string }
        postmanEnvironmentId: { type: string }
        lastDeploymentId: { type: string, format: uuid, nullable: true }
        ttlExpiresAt: { type: string, format: date-time, nullable: true }
        kind: { type: string, enum: [core, preview] }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, projectId, name, githubBranch, createdAt, updatedAt]
    CircuitBreakerState:
      type: object
      properties:
        name: { type: string }
        state: { type: string, enum: [closed, open, half_open] }
        failures: { type: integer }
        lastFailureTime: { type: integer, nullable: true, description: Unix epoch ms }
        halfOpenAttempts: { type: integer }
        halfOpenSuccesses: { type: integer }
      required: [name, state, failures, halfOpenAttempts, halfOpenSuccesses]
    EnvironmentMatrixMeta:
      type: object
      properties:
        rateLimit:
          type: object
          properties:
            userRemaining: { type: integer, nullable: true }
            projectRemaining: { type: integer, nullable: true }
        circuitBreakers:
          type: array
          items: { $ref: '#/components/schemas/CircuitBreakerState' }
      required: [rateLimit, circuitBreakers]
    EnvironmentMatrixResponse:
      type: object
      properties:
        environments:
          type: array
          items: { $ref: '#/components/schemas/Environment' }
        meta: { $ref: '#/components/schemas/EnvironmentMatrixMeta' }
      required: [environments, meta]
    CreateProjectRequest:
      type: object
      properties:
        name: { type: string, minLength: 3, maxLength: 64 }
        orgId: { type: string, format: uuid }
        integrations:
          type: object
          properties:
            github: { type: boolean }
            cloudflare: { type: boolean }
            neon: { type: boolean }
            postman: { type: boolean }
      required: [name, orgId]
    ApplyDiffRequest:
      type: object
      properties:
        projectId: { type: string, format: uuid }
        baseSha: { type: string }
        patch: { type: string }
      required: [projectId, baseSha, patch]
