# Implementation Plan: Neon Auth Migration (Mobile + API)

**Branch**: `003-neon-auth-migration` | **Date**: 2025-11-23 | **Spec**: ./spec.md
**Input**: Feature specification from `/specs/003-neon-auth-migration/spec.md`

## Summary

Replace BetterAuth with a unified Neon-backed auth system exposed via the Hono (Cloudflare Workers) API and consumed by the Expo mobile app using expo-auth-session and expo-secure-store. Support providers: Apple, Google, GitHub, plus Email + Password. Sessions are short-lived (~15 minutes) with 24-hour refresh, stored in Neon (PostgreSQL) via Drizzle. Codemagic orchestrates CI/CD workflows that leverage Expo's native build and deployment services (EAS Build, Expo Launch). All environments (dev/staging/prod) remain in parity. No legacy user linking is required; BetterAuth is fully removed.

## Technical Context

**Language/Version**: TypeScript (Node 20+ on Workers runtime), React Native (Expo SDK 51+)  
**Primary Dependencies**: Hono (Cloudflare Workers), Drizzle ORM, Neon serverless driver (HTTP), expo-auth-session, expo-secure-store, Zod, Codemagic (CI/CD orchestration), EAS Build, Expo Launch  
**Storage**: Neon PostgreSQL (users, identity_provider_links, sessions)  
**Testing**: Vitest (unit/integration), Postman collections (contract), Playwright (web flows; N/A for mobile auth flows)  
**Target Platform**: Cloudflare Workers (API), Expo (iOS/Android), Codemagic (CI/CD workflows)  
**Project Type**: Mobile + API + CI/CD Integration  
**Performance Goals**: API p95 < 300ms for auth endpoints; mobile auth flows complete < 2 minutes for 95%  
**Constraints**: No secrets in logs; environment parity; idempotent provisioning; redaction middleware; least-privilege tokens  
**Scale/Scope**: Initial cohorts (<10k users); multi-device sessions per user; providers: Apple/Google/GitHub/Email+Password

## Constitution Check

1. Spec-First Orchestration
   - Spec present with user stories, requirements, success criteria: `specs/003-neon-auth-migration/spec.md`
   - Checklist completed: `specs/003-neon-auth-migration/checklists/requirements.md`

2. Environment Parity & Idempotent Automation
   - Resources per env: Neon DB branch (users/sessions), Cloudflare Worker routes, GitHub secrets for provider creds, Codemagic workflows for Expo build/deploy.
   - Idempotency: Auth DB migrations are deterministic; route registration declarative; provider config fetched via env bindings; Codemagic workflows configured per environment.

3. Tool-/MCP-Centric AI Workflow
   - MCP tools (future): `auth.register`, `auth.login`, `auth.refresh`, `auth.oauthCallback` for automated validation or test harness.
   - Input/Output schemas: Reference Zod schemas in `packages/types/src/auth/*` (to be added in Phase 1). Tools updated in `/mcp/servers/` accordingly.

4. Security, Observability & Audit
   - Secrets: Provider client IDs/secrets, JWT signing key, email transport (if used). Stored in GitHub/Cloudflare; synced via existing secrets sync feature (002).
   - Logging: Structured logs with correlationId for auth flows; redaction middleware ensures no token/secret leakage.
   - Metrics: Sign-in success rate, refresh success, error codes by provider, duration metrics.

5. Monorepo Simplicity & Reusable Primitives
   - No new packages required. Use existing `packages/types` for Zod schemas, `packages/utils` for helpers, `packages/api-client` for typed client updates.
   - Complexity table: N/A (no violations).

All gates PASS. Proceeding to research and design phases.

## Project Structure

### Documentation (this feature)

```text
specs/003-neon-auth-migration/
├── plan.md              # This file (generated by planning)
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
└── contracts/           # Phase 1 output (OpenAPI for auth endpoints)
```

### Source Code (repository root)

```text
apps/
  api/                # Hono on Cloudflare Workers (auth routes live here)
    src/
      routes/
        auth/        # new: login.ts, register.ts, refresh.ts, oauthCallback.ts
      services/
        auth/        # new: authService.ts (session mgmt), providers/
    db/
      schema/        # users.ts, sessions.ts, identityProviderLinks.ts (Drizzle)
  mobile/             # Expo app (expo-auth-session, expo-secure-store)
    app/
      (auth)/        # sign-in screens and guarded routes
      api/           # typed API wrappers using packages/api-client

packages/
  types/              # Zod schemas for auth requests/responses/entities
  api-client/         # Add auth resources (register/login/refresh)
  utils/              # Shared helpers (time, storage adapters)
```

**Structure Decision**: Mobile + API: implement server-side auth (Hono/Neon) and mobile client flows (Expo) using shared types and client wrappers.

## Complexity Tracking

N/A – No Constitution violations or extra packages required.
