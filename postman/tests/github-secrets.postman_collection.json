{
  "info": {
    "name": "GitHub Secrets Synchronization API",
    "description": "Contract tests for GitHub secrets sync, environment provisioning, and validation endpoints",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_postman_id": "002-github-secrets-sync",
    "version": "1.0.0"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{AUTH_TOKEN}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "BASE_URL",
      "value": "http://localhost:8787",
      "type": "string"
    },
    {
      "key": "PROJECT_ID",
      "value": "123e4567-e89b-12d3-a456-426614174000",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Secret Synchronization",
      "item": [
        {
          "name": "Sync Secrets - Success",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has required fields', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('syncedCount');",
                  "    pm.expect(json).to.have.property('skippedCount');",
                  "    pm.expect(json).to.have.property('errors');",
                  "    pm.expect(json).to.have.property('correlationId');",
                  "    pm.expect(json).to.have.property('durationMs');",
                  "});",
                  "",
                  "pm.test('Correlation ID is valid UUID', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.correlationId).to.match(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i);",
                  "});",
                  "",
                  "pm.test('syncedCount is non-negative integer', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.syncedCount).to.be.a('number');",
                  "    pm.expect(json.syncedCount).to.be.at.least(0);",
                  "});",
                  "",
                  "pm.test('errors is array', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.errors).to.be.an('array');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"force\": false,\n  \"targetScopes\": [\"codespaces\", \"dependabot\"]\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/sync",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "sync"]
            }
          }
        },
        {
          "name": "Sync Secrets - Invalid Project ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400 or 404', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([400, 404]);",
                  "});",
                  "",
                  "pm.test('Error response has structure', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('error');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"invalid-uuid\",\n  \"force\": false\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/sync",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "sync"]
            }
          }
        },
        {
          "name": "Get Secret Sync Status - Success",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has required fields', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('status');",
                  "    pm.expect(json).to.have.property('pendingCount');",
                  "    pm.expect(json).to.have.property('errorCount');",
                  "    pm.expect(json).to.have.property('quotaRemaining');",
                  "});",
                  "",
                  "pm.test('Status is valid enum value', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.status).to.be.oneOf(['synced', 'pending', 'error', 'never_synced']);",
                  "});",
                  "",
                  "pm.test('Quota remaining has core and secrets', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.quotaRemaining).to.have.property('core');",
                  "    pm.expect(json.quotaRemaining).to.have.property('secrets');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/sync/status?projectId={{PROJECT_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "sync", "status"],
              "query": [
                {
                  "key": "projectId",
                  "value": "{{PROJECT_ID}}"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Environment Management",
      "item": [
        {
          "name": "Create Environments - Dev Only",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has created/updated/errors arrays', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('created');",
                  "    pm.expect(json).to.have.property('updated');",
                  "    pm.expect(json).to.have.property('errors');",
                  "    pm.expect(json).to.have.property('correlationId');",
                  "});",
                  "",
                  "pm.test('created is array', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.created).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Correlation ID is valid UUID', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.correlationId).to.match(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"environments\": [\n    {\n      \"name\": \"dev\",\n      \"protectionRules\": {\n        \"requiredReviewers\": 0,\n        \"restrictToMainBranch\": false,\n        \"waitTimer\": 0\n      },\n      \"secrets\": [\n        {\n          \"name\": \"NEON_BRANCH_ID\",\n          \"value\": \"br-dev-test-123\"\n        }\n      ],\n      \"linkedResources\": {\n        \"neonBranchId\": \"br-dev-test-123\"\n      }\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/environments",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "environments"]
            }
          }
        },
        {
          "name": "Create Environments - All Three",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Created or updated 3 environments', function () {",
                  "    const json = pm.response.json();",
                  "    const total = json.created.length + json.updated.length;",
                  "    pm.expect(total).to.equal(3);",
                  "});",
                  "",
                  "pm.test('No errors in response', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.errors).to.be.an('array').that.is.empty;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"environments\": [\n    {\n      \"name\": \"dev\",\n      \"protectionRules\": {\"requiredReviewers\": 0, \"restrictToMainBranch\": false, \"waitTimer\": 0},\n      \"secrets\": [{\"name\": \"NEON_BRANCH_ID\", \"value\": \"br-dev-123\"}],\n      \"linkedResources\": {\"neonBranchId\": \"br-dev-123\"}\n    },\n    {\n      \"name\": \"staging\",\n      \"protectionRules\": {\"requiredReviewers\": 1, \"restrictToMainBranch\": false, \"waitTimer\": 0},\n      \"secrets\": [{\"name\": \"NEON_BRANCH_ID\", \"value\": \"br-staging-456\"}],\n      \"linkedResources\": {\"neonBranchId\": \"br-staging-456\"}\n    },\n    {\n      \"name\": \"production\",\n      \"protectionRules\": {\"requiredReviewers\": 1, \"restrictToMainBranch\": true, \"waitTimer\": 0},\n      \"secrets\": [{\"name\": \"NEON_BRANCH_ID\", \"value\": \"br-prod-789\"}],\n      \"linkedResources\": {\"neonBranchId\": \"br-prod-789\"}\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/environments",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "environments"]
            }
          }
        },
        {
          "name": "Create Environments - Invalid Name",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error response structure', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('error');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"environments\": [\n    {\n      \"name\": \"invalid-env\",\n      \"protectionRules\": {\"requiredReviewers\": 0, \"restrictToMainBranch\": false, \"waitTimer\": 0},\n      \"secrets\": [],\n      \"linkedResources\": {}\n    }\n  ]\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/environments",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "environments"]
            }
          }
        }
      ]
    },
    {
      "name": "Secret Validation",
      "item": [
        {
          "name": "Validate Secrets - All Valid",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has validation structure', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('valid');",
                  "    pm.expect(json).to.have.property('missing');",
                  "    pm.expect(json).to.have.property('conflicts');",
                  "    pm.expect(json).to.have.property('summary');",
                  "    pm.expect(json).to.have.property('remediationSteps');",
                  "});",
                  "",
                  "pm.test('valid is boolean', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.valid).to.be.a('boolean');",
                  "});",
                  "",
                  "pm.test('Summary has counts', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.summary).to.have.property('totalSecrets');",
                  "    pm.expect(json.summary).to.have.property('missingCount');",
                  "    pm.expect(json.summary).to.have.property('conflictCount');",
                  "    pm.expect(json.summary).to.have.property('validCount');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"requiredSecrets\": [\"DATABASE_URL\", \"API_KEY\"]\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/validate",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "validate"]
            }
          }
        },
        {
          "name": "Validate Secrets - Missing Detected",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200 or 207', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 207]);",
                  "});",
                  "",
                  "pm.test('missing array present', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json.missing).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Remediation steps provided when invalid', function () {",
                  "    const json = pm.response.json();",
                  "    if (!json.valid) {",
                  "        pm.expect(json.remediationSteps).to.be.an('array').that.is.not.empty;",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"requiredSecrets\": [\"MISSING_SECRET_1\", \"MISSING_SECRET_2\", \"DATABASE_URL\"]\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/validate",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "validate"]
            }
          }
        },
        {
          "name": "Validate Secrets - Empty Array",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"requiredSecrets\": []\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/validate",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "validate"]
            }
          }
        }
      ]
    },
    {
      "name": "Authorization & Error Handling",
      "item": [
        {
          "name": "Unauthorized Request",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"projectId\": \"{{PROJECT_ID}}\",\n  \"force\": false\n}"
            },
            "url": {
              "raw": "{{BASE_URL}}/github/secrets/sync",
              "host": ["{{BASE_URL}}"],
              "path": ["github", "secrets", "sync"]
            }
          }
        }
      ]
    }
  ]
}
