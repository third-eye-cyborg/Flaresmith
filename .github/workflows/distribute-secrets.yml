name: Distribute Secrets

on:
  workflow_dispatch:
    inputs:
      target_scopes:
        description: 'Target scopes (comma-separated: codespaces,environments,cloudflare,neon)'
        required: true
        default: 'codespaces,environments'
        type: string
      dry_run:
        description: 'Dry run (show what would be done)'
        required: false
        default: false
        type: boolean
      force_overwrite:
        description: 'Force overwrite existing secrets'
        required: false
        default: false
        type: boolean

jobs:
  distribute:
    name: Distribute Secrets to Scopes
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
      actions: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Parse target scopes
        id: scopes
        run: |
          SCOPES="${{ inputs.target_scopes }}"
          echo "codespaces=$([[ $SCOPES == *"codespaces"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "environments=$([[ $SCOPES == *"environments"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "cloudflare=$([[ $SCOPES == *"cloudflare"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "neon=$([[ $SCOPES == *"neon"* ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
      
      # ============================================
      # Codespaces Secrets Distribution
      # ============================================
      - name: Distribute to Codespaces
        if: steps.scopes.outputs.codespaces == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "üì¶ Distributing secrets to Codespaces..."
          
          # Development secrets (non-environment specific)
          CODESPACE_SECRETS=(
            "EXPO_TOKEN=${{ secrets.EXPO_TOKEN }}"
            "FIGMA_API_KEY=${{ secrets.FIGMA_API_KEY }}"
            "LINEAR_API_KEY=${{ secrets.LINEAR_API_KEY }}"
            "MAPBOX_API_KEY=${{ secrets.MAPBOX_API_KEY }}"
            "NOTION_API_KEY=${{ secrets.NOTION_API_KEY }}"
            "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            "POSTMAN_API_KEY=${{ secrets.POSTMAN_API_KEY }}"
            "POLAR_API_KEY=${{ secrets.POLAR_API_KEY }}"
            "CYPRESS_WEB_TOKEN=${{ secrets.CYPRESS_WEB_TOKEN }}"
            "CYPRESS_MOBILE_TOKEN=${{ secrets.CYPRESS_MOBILE_TOKEN }}"
            "PLAYWRIGHT_WEB_TOKEN=${{ secrets.PLAYWRIGHT_WEB_TOKEN }}"
            "PLAYWRIGHT_MOBILE_TOKEN=${{ secrets.PLAYWRIGHT_MOBILE_TOKEN }}"
            "STORYBOOK_WEB_TOKEN=${{ secrets.STORYBOOK_WEB_TOKEN }}"
            "STORYBOOK_MOBILE_TOKEN=${{ secrets.STORYBOOK_MOBILE_TOKEN }}"
          )
          
          for SECRET_PAIR in "${CODESPACE_SECRETS[@]}"; do
            SECRET_NAME="${SECRET_PAIR%%=*}"
            SECRET_VALUE="${SECRET_PAIR#*=}"
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  Skipping $SECRET_NAME (empty value)"
              continue
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "üîç [DRY RUN] Would set Codespace secret: $SECRET_NAME"
            else
              echo "‚úì Setting Codespace secret: $SECRET_NAME"
              gh secret set "$SECRET_NAME" --repo ${{ github.repository }} --app codespaces --body "$SECRET_VALUE"
            fi
          done
      
      # ============================================
      # GitHub Environments Setup & Secrets
      # ============================================
      - name: Setup GitHub Environments
        if: steps.scopes.outputs.environments == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "üåç Setting up GitHub Environments..."
          
          ENVIRONMENTS=("dev" "staging" "production")
          
          for ENV in "${ENVIRONMENTS[@]}"; do
            if [ "$DRY_RUN" = "true" ]; then
              echo "üîç [DRY RUN] Would create/update environment: $ENV"
            else
              echo "‚úì Creating/updating environment: $ENV"
              
              # Create environment (idempotent via GitHub API)
              gh api \
                --method PUT \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                /repos/${{ github.repository }}/environments/$ENV \
                -f "wait_timer=0" || echo "Environment $ENV may already exist"
            fi
          done
      
      - name: Distribute to Dev Environment
        if: steps.scopes.outputs.environments == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "üîß Distributing secrets to DEV environment..."
          
          # Dev-specific secrets
          ENV_SECRETS=(
            "DATABASE_URL=${{ secrets.DATABASE_URL }}"
            "NEON_API_KEY=${{ secrets.NEON_API_KEY }}"
            "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
            "CLOUDFLARE_API_KEY=${{ secrets.CLOUDFLARE_API_KEY }}"
            "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}"
            "ONESIGNAL_API_KEY=${{ secrets.ONESIGNAL_API_KEY }}"
            "ONESIGNAL_APP_ID=${{ secrets.ONESIGNAL_APP_ID }}"
            "SLACK_ACCESS_TOKEN=${{ secrets.SLACK_ACCESS_TOKEN }}"
            "SLACK_REFRESH_TOKEN=${{ secrets.SLACK_REFRESH_TOKEN }}"
          )
          
          for SECRET_PAIR in "${ENV_SECRETS[@]}"; do
            SECRET_NAME="${SECRET_PAIR%%=*}"
            SECRET_VALUE="${SECRET_PAIR#*=}"
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  Skipping $SECRET_NAME (empty value)"
              continue
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "üîç [DRY RUN] Would set dev environment secret: $SECRET_NAME"
            else
              echo "‚úì Setting dev environment secret: $SECRET_NAME"
              gh secret set "$SECRET_NAME" \
                --repo ${{ github.repository }} \
                --env dev \
                --body "$SECRET_VALUE"
            fi
          done
      
      - name: Distribute to Staging Environment
        if: steps.scopes.outputs.environments == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "üîß Distributing secrets to STAGING environment..."
          
          # Same secrets as dev, but could be different values in practice
          ENV_SECRETS=(
            "DATABASE_URL=${{ secrets.DATABASE_URL }}"
            "NEON_API_KEY=${{ secrets.NEON_API_KEY }}"
            "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
            "CLOUDFLARE_API_KEY=${{ secrets.CLOUDFLARE_API_KEY }}"
            "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}"
            "ONESIGNAL_API_KEY=${{ secrets.ONESIGNAL_API_KEY }}"
            "ONESIGNAL_APP_ID=${{ secrets.ONESIGNAL_APP_ID }}"
            "SLACK_ACCESS_TOKEN=${{ secrets.SLACK_ACCESS_TOKEN }}"
            "SLACK_REFRESH_TOKEN=${{ secrets.SLACK_REFRESH_TOKEN }}"
          )
          
          for SECRET_PAIR in "${ENV_SECRETS[@]}"; do
            SECRET_NAME="${SECRET_PAIR%%=*}"
            SECRET_VALUE="${SECRET_PAIR#*=}"
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  Skipping $SECRET_NAME (empty value)"
              continue
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "üîç [DRY RUN] Would set staging environment secret: $SECRET_NAME"
            else
              echo "‚úì Setting staging environment secret: $SECRET_NAME"
              gh secret set "$SECRET_NAME" \
                --repo ${{ github.repository }} \
                --env staging \
                --body "$SECRET_VALUE"
            fi
          done
      
      - name: Distribute to Production Environment
        if: steps.scopes.outputs.environments == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "üîß Distributing secrets to PRODUCTION environment..."
          
          ENV_SECRETS=(
            "DATABASE_URL=${{ secrets.DATABASE_URL }}"
            "NEON_API_KEY=${{ secrets.NEON_API_KEY }}"
            "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
            "CLOUDFLARE_API_KEY=${{ secrets.CLOUDFLARE_API_KEY }}"
            "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}"
            "ONESIGNAL_API_KEY=${{ secrets.ONESIGNAL_API_KEY }}"
            "ONESIGNAL_APP_ID=${{ secrets.ONESIGNAL_APP_ID }}"
            "SLACK_ACCESS_TOKEN=${{ secrets.SLACK_ACCESS_TOKEN }}"
            "SLACK_REFRESH_TOKEN=${{ secrets.SLACK_REFRESH_TOKEN }}"
          )
          
          for SECRET_PAIR in "${ENV_SECRETS[@]}"; do
            SECRET_NAME="${SECRET_PAIR%%=*}"
            SECRET_VALUE="${SECRET_PAIR#*=}"
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  Skipping $SECRET_NAME (empty value)"
              continue
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "üîç [DRY RUN] Would set production environment secret: $SECRET_NAME"
            else
              echo "‚úì Setting production environment secret: $SECRET_NAME"
              gh secret set "$SECRET_NAME" \
                --repo ${{ github.repository }} \
                --env production \
                --body "$SECRET_VALUE"
            fi
          done
      
      # ============================================
      # Cloudflare Secrets Distribution
      # ============================================
      - name: Distribute to Cloudflare Workers
        if: steps.scopes.outputs.cloudflare == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "‚òÅÔ∏è  Distributing secrets to Cloudflare Workers..."
          
          # Secrets needed by Cloudflare Workers (API)
          CF_SECRETS=(
            "DATABASE_URL=${{ secrets.DATABASE_URL }}"
            "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
            "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}"
            "SLACK_ACCESS_TOKEN=${{ secrets.SLACK_ACCESS_TOKEN }}"
            "SLACK_REFRESH_TOKEN=${{ secrets.SLACK_REFRESH_TOKEN }}"
            "NEON_API_KEY=${{ secrets.NEON_API_KEY }}"
          )
          
          for SECRET_PAIR in "${CF_SECRETS[@]}"; do
            SECRET_NAME="${SECRET_PAIR%%=*}"
            SECRET_VALUE="${SECRET_PAIR#*=}"
            
            if [ -z "$SECRET_VALUE" ]; then
              echo "‚ö†Ô∏è  Skipping $SECRET_NAME (empty value)"
              continue
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "üîç [DRY RUN] Would set Cloudflare secret: $SECRET_NAME"
            else
              echo "‚úì Setting Cloudflare secret: $SECRET_NAME"
              # Use wrangler to set secrets
              echo "$SECRET_VALUE" | pnpm --filter @flaresmith/api wrangler secret put "$SECRET_NAME"
            fi
          done
      
      # ============================================
      # Summary
      # ============================================
      - name: Distribution Summary
        run: |
          echo ""
          echo "=================================================="
          echo "üìä Secret Distribution Summary"
          echo "=================================================="
          echo ""
          echo "Target Scopes:"
          echo "  - Codespaces: ${{ steps.scopes.outputs.codespaces }}"
          echo "  - Environments: ${{ steps.scopes.outputs.environments }}"
          echo "  - Cloudflare: ${{ steps.scopes.outputs.cloudflare }}"
          echo "  - Neon: ${{ steps.scopes.outputs.neon }}"
          echo ""
          echo "Mode: ${{ inputs.dry_run && 'DRY RUN' || 'LIVE' }}"
          echo "Force Overwrite: ${{ inputs.force_overwrite }}"
          echo ""
          echo "‚úÖ Distribution complete!"
          echo ""
          echo "Next steps:"
          echo "  1. Verify secrets in GitHub Settings ‚Üí Secrets and variables"
          echo "  2. Check Codespaces settings if applicable"
          echo "  3. Verify environment-specific secrets in Environments"
          echo "  4. Test deployment workflows to ensure secrets work"
          echo ""
