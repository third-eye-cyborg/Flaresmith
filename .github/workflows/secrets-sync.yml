name: Secrets Synchronization

on:
  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Run without mutating (true/false)'
        required: false
        default: 'true'
      environments:
        description: 'Sync environments (dev,staging,production)'
        required: false
        default: 'dev,staging,production'
  push:
    branches:
      - main
      - staging
      - 'feature/**'
      - 'fix/**'

permissions:
  contents: read
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (selective)
        run: |
          corepack enable
          pnpm install --filter "flaresmith..." --no-frozen-lockfile

      - name: Prepare env lists
        id: prep
        run: |
          echo "SYNC_GLOBALS=BUILDER_API_KEY,CLOUDFLARE_ACCOUNT_ID,CLOUDFLARE_API_KEY,EXPO_TOKEN,FIGMA_API_KEY,LINEAR_API_KEY,MAPBOX_API_KEY,NEON_API_KEY,NOTION_API_KEY,ONESIGNAL_API_KEY,ONESIGNAL_APP_ID,OPENAI_API_KEY,POLAR_API_KEY,POSTHOG_API_KEY,POSTMAN_API_KEY,SLACK_ACCESS_TOKEN,SLACK_REFRESH_TOKEN" >> $GITHUB_ENV
          echo "SYNC_ENV_BASES=DATABASE_URL" >> $GITHUB_ENV
          echo "SYNC_ENV_BRANCHES=NEON_BRANCH" >> $GITHUB_ENV
          echo "DRY_RUN=${{ github.event.inputs.dryRun || 'true' }}" >> $GITHUB_ENV

      - name: Run secret sync (dry-run prints planned operations)
        env:
          GITHUB_OWNER: third-eye-cyborg
          GITHUB_REPO: CloudMake
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILDER_API_KEY: ${{ secrets.BUILDER_API_KEY }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_KEY: ${{ secrets.CLOUDFLARE_API_KEY }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          FIGMA_API_KEY: ${{ secrets.FIGMA_API_KEY }}
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          MAPBOX_API_KEY: ${{ secrets.MAPBOX_API_KEY }}
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          POLAR_API_KEY: ${{ secrets.POLAR_API_KEY }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          SLACK_ACCESS_TOKEN: ${{ secrets.SLACK_ACCESS_TOKEN }}
          SLACK_REFRESH_TOKEN: ${{ secrets.SLACK_REFRESH_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          # Optional environment-specific secrets (uncomment if defined in repo settings):
          # DATABASE_URL_DEV: ${{ secrets.DATABASE_URL_DEV }}
          # DATABASE_URL_STAGING: ${{ secrets.DATABASE_URL_STAGING }}
          # DATABASE_URL_PROD: ${{ secrets.DATABASE_URL_PROD }}
          # NEON_BRANCH_DEV: ${{ secrets.NEON_BRANCH_DEV }}
          # NEON_BRANCH_STAGING: ${{ secrets.NEON_BRANCH_STAGING }}
          # NEON_BRANCH_PROD: ${{ secrets.NEON_BRANCH_PROD }}
        run: |
          pnpm exec tsx scripts/github/workflowSyncSecrets.ts

      - name: Validation (API)
        if: ${{ github.event.inputs.dryRun != 'true' }}
        run: |
          echo "Skip API validation step unless API base + projectId secrets configured."

      - name: Summary
        run: echo "Secret sync workflow finished."
